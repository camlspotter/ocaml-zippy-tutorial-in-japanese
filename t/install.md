OCaml のインストール
===============================================

OCaml でプログラム開発を行う場合、まずコンパイラを含む OCaml 処理系がまず必要です。

次に重要なのは OPAM。OCaml ソフトウェアのインストールを自動的に行うパッケージマネージャです。
それ以外のライブラリやツールはほぼ OPAM を通してインストールする事ができます。
ですから、各種 Unix や OS X など、OPAM が動く環境の場合は必ずインストールするべきです。
(Windows では OPAM はまだ動きません。)

この章では 

* OCaml 処理系のインストール
* (OPAM がインストール可能な環境での) OPAM パッケージマネージャのインストール
* OPAM を使った OCaml の処理系の(再)インストール(`opam switch`)

の手順について解説します。

大まかなインストール手順フロー
--------------------------------------------

OCaml を自分のシステムにどうインストールするか、次のフローチャートが参考になるでしょう。

* OPAM が動作する環境 (Unix, Linux, OS X など)
    * OPAM のバイナリ配布が使用可能で、使用したい場合
        * OPAM のバイナリをインストール
        * `opam switch` による OCaml 処理系のインストール
    * OPAM が動作する環境だが、OPAM のバイナリ配布が使用不可能、もしくは使用したくない場合
        * OPAM をソースからインストールするための OCaml 処理系が必要
            * OCaml のバイナリ配布が使用可能で、使用したい場合
                * OCaml のバイナリをインストール
            * OCaml のバイナリ配布が使用不可能、もしくは使用したくない場合
                * OCaml をソースコードからインストール
        * インストールした OCaml 処理系を使って OPAM をインストール
        * `opam switch` による OCaml 処理系の再インストール
* OPAM が動作しない環境 (Windowsなど)
      * OCaml のバイナリ配布が使用可能で、使用したい場合
          * OCaml のバイナリをインストール
      * OCaml のバイナリ配布が使用不可能、もしくは使用したくない場合
          * OCaml をソースコードからインストール

(CR jfuruse: Graphviz とかで書きたい)

### Windows は避けたい

Windows 上で OCaml は使用可能ですし、実際に Windows 上で開発を行っている
個人、企業は複数存在します。が、Unix由来のプログラム開発全般に言えることですが、
Windows ではかなり苦労をすることになります。OCaml を使って純粋にプログラミングを
楽しみたいのであれば、 Windows は避けましょう。Windows の上に仮想 Linux 環境を
VMWare Player や VirtualPC で構築した方がスムーズに事が進みます。

ただそれでもあえて Windows 上で OCaml を使用したいという場合は
後述の各OSでの注意点を参考にしてください。






OCaml のインストール
-------------------------------------------

OCaml 処理系をインストールするには、三つの方法があります:

* ソースコードを公式ウェブサイトから入手し、アーカイブ内のドキュメントに従い手動でインストールする
* OCaml のソースパッケージマネージャである OPAM を使い、OCaml のソースコードの入手からインストールまでを自動的に行う
* OS ディストリビューションなどが提供するバイナリパッケージを利用する

### ソースコードからの手動インストール

公式ページ http://ocaml.org/releases/ から最新版(latest)の OCaml ソースコードを入手します。
ソースコードアーカイブの中にある `INSTALL` と `PREREQUISITES`
(Windows 系の場合はさらに `README.win32`) というファイルの手順に従い
インストール作業を行ってください。

非常に理想的な環境でインストール作業が問題なく成功した場合の手順は次のようになります:

```shell
$ ./configure --prefix <プリフィクス>        <== /usr などインストール先を指定
...
$ make world.opt                          <== コンパイル
...
$ make install
...
```

もちろんあなたの環境は理想的ではないので、こう簡単にはいきません。是非ソースコードに付属している上記ドキュメントを良く読んで作業を行ってください。一度うまく動いたインストール手順は次に OCaml 処理系のバージョンアップがあった場合でもまず同じように動きます。手順をスクリプトにまとめておくと便利です。

#### 手動でインストールした場合でも、OPAM をインストールして、OPAM を通して OCaml をインストールしなおす

OPAM は種々のライブラリのインストールを自動化してくれます。OPAM を使わずソースコードから 
OCaml をインストールした場合でも、OPAM がサポートされている環境であるならば、
是非 OPAM をインストールするべきです。
そしてインストールした OPAM を使って OCaml 処理系を再度インストールしなおしてください。

OPAM からインストールできる OCaml 処理系のコードでは、リリース時には発見できていなかった
あなたの環境特有のバグが修正されている可能性があります。このようなバグフィクスは、
公式ソースコードを使っているかぎり、次のリリースまで統合されません。ですから、本来ならば
自分でパッチをみつけてきて手動で適用、再コンパイルしなければいけないのです。
OPAM を使えばそのステップが自動化できる場合があります。
(実際 Mac OS X では、最近の clang に関する変更により、公式 OCaml 4.02.1 では外部
C 関数のコードがうまくコンパイルできません。OPAM からインストールした OCaml
ではこの問題は修正されています。)

### OPAM を使った OCaml のインストール

OPAM が利用可能である場合、 OCaml 処理系のインストールは非常に簡単です:

```shell
$ opam switch 4.02.1
...                         <== しばらく待つ
```

`4.02.1` は OCaml 処理系のバージョンです。特に支障が無い限り最新の物を選びましょう。
`opam switch list` で利用可能なバージョンリストが表示されます。

#### ``eval `opam config env` `` を忘れない

`opam switch` を行った後、**必ず** ``eval `opam config env` `` を行って
環境設定することを忘れないでください。

通常、 `opam switch <バージョン>` を行うと OCaml 処理系は 
`$HOME/.opam/<バージョン>` ディレクトリの下にインストールされます。以降の
OPAM パッケージのインストール先もこのディレクトリの下になります。
``eval `opam config env` `` は各種環境変数がこのディレクトリを指すように
変更します。

これを忘れると異る OCaml 処理系のバージョンが複数存在する場合、不可解な現象に
悩まされることになります。
(実際には自分の想定しているバージョンの処理系を使っていない、というだけなのですが、
知らずにこの問題に引っ掛ると次から次に起る全く理解できない問題に苦しむことになります。)

#### `opam switch` がうまくいかなかった場合

特殊なOSやディストリビューションを使っていないかぎり、正式リリースされたバージョンの
`opam switch` が失敗することは無いはずです。
それでも失敗する場合には、依存するツールが足りないなどの原因があるかもしれません。エラーログを良く読んで
必要なツールを揃えてみてください。OPAM でのインストールを一旦あきらめて、
インストールのドキュメントを読みながら、ソースコードからの手動インストールを行うのも一手です。

#### `opam switch` できたら `system` は捨ててしまってもよい。

OPAM を通さずに手動やディストリビューションパッケージからインストールされた OCaml は
`system` と呼ばれます。`opam switch <バージョン>` でインストールした
OCaml はもしバージョンが 4.02.1 ならば `4.02.1` と呼ばれます。
`opam switch` で OCaml 処理系をインストールしなおした後で、 `system` コンパイラを
積極的に使う必要はありません。もし `system` と `<バージョン>` が共に存在しているのが
混乱を招くと思われるのならば、`<バージョン>` の安定動作を確認の後、 `system` は
消してしまってもかまいません。

(CR jfuruse: どうやって system を消すか)

### OS ディストリビューションなどのパッケージシステムから OCaml をインストールする

各種 Linux, Mac OS X, Windows など、OCaml 処理系のパッケージが用意されている
OS、ディストリビューションは意外と多いので、それを利用して OCaml をインストールしてしまうのも
楽で良い方法かもしれません。

ただし…パッケージによっては大小いろいろな問題があるようです。
一番良くあるのが、古い OCaml のバージョンしか用意されていない、というものです。
アンインストーラーにバグがあり、アンインストール時に他のシステムにも重要な環境変数が
上書きされてしまった、という困ったバイナリパッケージもありました。

OCaml 使用者と比べると、特定ディストリビューションの OCaml パッケージを使っているという
人の数はとても少くなりますし、 OCaml 開発チームも個々のバイナリパッケージやインストーラーに
対して責任や興味は持っていません。これは、何かパッケージ特有の問題があった場合、助けてくれる人の数
が少いということです。ですから、あまりお勧めしたくない方法です。

なお、OPAM をスムーズにコンパイルするためにはおそらくバージョン 4.00.0 以上の OCaml が
パッケージシステムにより提供されている必要があると思います。それ以下の、例えば 3.12.1 
などの場合は始めからソースからのインストールを行ったほうがよいでしょう。

(CR jfuruse: OPAM に必要な OCaml のバージョンは未確認。確認しても上る可能性ある…)

各ディストリビューションでのパッケージのインストール方法についてはそれぞれの
ディストリビューションにより異るので、触れません。

もし OS ディストリビューションの OCaml パッケージを使って OCaml をインストールした場合でも、
OPAM が利用できるところでは OPAM をインストールして、是非 `opam switch` で OCaml 処理系
一式をソースからコンパイルしなおしてください。ディストリビューションのパッケージでは修正されていない
バグが直っている事があるかもしれません。

### OCaml がインストールされているか確認

さて、最後にちゃんと OCaml がインストールされているかどうか、確認しておきましょう:

```shell
$ ocamlc -version
4.02.1                  <== あなたのインストールしたバージョンが表示されるはず
```

ちゃんとあなたのインストールした OCaml のバージョン番号が表示されているでしょうか。



OPAM のインストール
-------------------------------------------

OPAM のインストールもソースから自分でコンパイルする方法と、
バイナリパッケージを使用する方法とがあります。
共に詳しい説明は https://opam.ocaml.org/doc/Install.html を参照してください。

### OPAM をソースからコンパイルする

OPAM は OCaml で書かれています。ですから、 OPAM をソースコードからインストールする場合には
事前に何らかの方法で OCaml がインストールされていなければいけません。上記の OCaml の
インストール方法を参考にまず OCaml を用意してください。もちろんこの時点で OPAM はインストール
されていないはずですから、 「OPAM を使った OCaml のインストール」の方法は使えません。

OPAM のソースからのインストール方法は `README.md` に書いてあります。良く読んでください。
Git でレポジトリから直接取ってきた場合など、周辺ライブラリが同梱されていないソースをダウンロードした
場合には `configure` 後に `make lib-ext` する事を忘れなければ問題無いはずです。

### バイナリパッケージによる OPAM のインストール

いくつかのディストリビューションや OS では OPAM のバイナリパッケージが用意されていますので、
それを使うのもよいでしょう。ただし、あまりお勧めしません。

OPAM は比較的新しいソフトウェアなので、最新の安定バージョンでさえユーザーによっては不具合いが
発生する可能性がまだあります。そのような場合はソースレポジトリから OPAM の開発版を入手しソース
から再インストールすると問題が解決されていることが多いのです。バージョン 1.1.0 の頃はこのような事が
頻繁に起きました。現在の安定バージョン 1.2.0 ですがこのような事が起る可能性は否定できません。
ですので、OPAM はソースコードからインストールすることをお勧めします。

### OPAM は OPAM ではインストールできない

今のところ、OPAM は `opam install opam` ではインストールできません。
自動的に OPAM のバージョンを上げる際に `$HOME/.opam` に存在するデータベースファイルの
整合性をちゃんと保ったまま正しく移行できるのか、不安な事からサポートされていないようです。

(CR jfuruse: では手動で OPAM をアップグレードした場合、 `$HOME/.opam` はどうしたらいいの？)

### OPAM がインストールされているか確認

書く
書く
書く
書く
書く
書く
書く
書く
書く

### OPAM を初めて使う

書く
書く
書く
書く
書く
書く
書く
書く
書く

### OPAM でにっちもさっちも行かなくなったら

書く
書く
書く
書く
書く
書く
書く
書く
書く

OPAM の調子が悪くなり、どうしても直らない場合は、 `$HOME/.opam` ディレクトリを消去して
全てをやりなおす事ができます。再構成には時間がかかるかもしれませんが確実です。

各OS での注意点
-----------------------------------------------

### Linux や BSD系

OCamlシステムの開発者たちが好んで使ってきたのが Linux や BSD系の OS、ディストリビューションです。
一般のユーザーも多いと思われますので、何か固有の問題があった場合でも情報の共有は楽な部類です。

Debian は OCaml 開発チームで長らく使われてきた環境です。おそらく今でも使っている人は
多いでしょう。その流れから Ubuntu での一般ユーザー数も多いと思われます。

Red Hat や Fedora は Jane Street などで使われています。これも安心です。

BSD系は Linuxに比べると人は少いですが、FreeBSD で OCaml を開発している人もいました。

### OS X

Mac は意外にも Caml界では長く愛されてきたコンピューターで、 OCaml の前進である
Caml Light は Mac Plus (1986年発売の 68000が 8MHz でノロノロと動く、
メモリが最大でも4MB しか乗らないマシンですよ?!?!)でも動作しました。

その伝統もあるのでしょうか、OS X でも OCaml は問題なく動きますし、ユーザーも
沢山います。

これらのユーザーのほとんどは外部ライブラリのインストールには Homebrew を使っているようです。
MacPorts を使う強い理由が無い限りは Homebrew を使ってください。

### Windows

Windows 上での OCaml プログラム開発を行うことは不可能ではありませんが、困難を伴います。

Windows でも Chocolatey https://chocolatey.org/packages ソフトウェア
パッケージシステムの普及にともない、開発ライブラリを揃えるのは少しずつ楽になっては
来ましたが、それでもまだ Unix 系のパッケージシステムの便利さに比べるといろいろ厄介です。

#### 三種類の「移植」

まず、Windows 版 OCaml と言っても Cygwin, MinGW, MS native の三種類の移植が
存在しており、それぞれ使える機能、出来たバイナリの配布ライセンス、スピード特性が
違います。詳しくは OCaml コンパイラのソースコードにある `README.win32` を
参照してください。(さらに MS native には 32bit版と 64bit版があります。)

ただでさえ少ない OCaml の Windows の使用者はさらにこの三種類の移植によって
分断されています。コミュニティで何か質問するにしてもこの移植の違いを理解している人が
まずあまりいません。例えば、「Windows で OCaml を使っているのですが◯◯がうまくいきません」
という(まずい)質問をあなたがした場合、折角答えてくれる人が表れても、別の移植での
話だった…ということは十分にありえます。何か問題が起った場合でも、コミュニティのサポートは
Unix系 OCaml ほどは期待できません。

#### Windows での動作が未確認の OCaml ライブラリが多い

Windows 特有の事情、Unix とは違う改行コードや、EOF の扱いを意識して書かれた
OCaml ライブラリは少ないのでしばしば修正が必要になります。
また、 Cygwin 以外の移植の Unix モジュールは機能が制限されており、
`Unix.exec` などが動きません。Cygwin 以外では OCaml から別のプログラムを
実行する場合は Windows API を呼び出すライブラリを自作する必要があります。

どの移植を使うにせよ、Windows での OCamlプログラム開発では Cygwin 環境を
ビルドツールとして使うことが多くなると思います。(外部ライブラリが GNU Make
を仮定しているなどしているとそうなります) が、Cygwin はプロセス生成(fork+exec)
に大きなオーバーヘッドがあり、 `make` コマンドなどのようなサブプロセスを
多数発生させるビルドは異様に時間がかかります。ウィルスチェッカーを走らせている場合、
OCaml コンパイラの起動にさらに時間が取られる事になるので設定に注意が必要です。
Cygwin や OCaml プログラムに対し頻出するウィルス感染偽陽性警告の扱いも面倒です。

#### OPAM は動かない

OPAM はまだ Windows では動きません。そのため、OCaml ライブラリをインストールする
際にはソースコードから一つ一つ入れていく事になります。

#### それでもインストールしたい場合

これらの問題を理解してなお OCaml を Windows で使いたい場合は、
`README.win32` を良く読んで、自分の使用条件にあった移植を選び、
ソースコードからインストールするか対応するインストーラーを使ってください。

MinGW 移植には Wodi というパッケージシステムがありますが、活動はあまり
活発ではありません。使ってもあまり得られるものはないでしょう。
ただ、Wodi のレポジトリには各パッケージを MinGW OCaml でコンパイルするための
パッチが用意されています、これを貰ってきて手元のライブラリのコンパイルに
使用するのは賢い方法だと思われます。

また、Unix 上で Windows の MinGW 用バイナリをクロスコンパイルしている
人もほんの少しですがいらっしゃるようです。ただしこれを行うには C コンパイラの
クロスコンパイル状況であったり、 OCaml コンパイラのビルド事情に詳しい方でなければ
手を出さないほうがよいでしょう。
